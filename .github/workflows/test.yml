name: Soroban Smart Contracts â€” Tests & Coverage

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: macos-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source $HOME/.cargo/env

    - name: Install Rust target for Soroban
      run: |
        source $HOME/.cargo/env
        rustup target add wasm32v1-none

    - name: Install cargo-llvm-cov
      run: |
        source $HOME/.cargo/env
        cargo install cargo-llvm-cov

    - name: Run tests and generate coverage reports
      run: |
        source $HOME/.cargo/env
        mkdir -p coverage/html

        # Run tests and print stats to the log
        cargo llvm-cov test

        # Generate LCOV report for IDE integration
        cargo llvm-cov test --lcov --output-path=coverage/lcov.info

        # Generate HTML report
        cargo llvm-cov test --html --output-dir=coverage/html

    - name: Post coverage comment on PR
      if: github.event_name == 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        REPO: ${{ github.repository }}
      run: |
        # Parse lcov.info and build the coverage table
        COMMENT="## ðŸ“Š Test Coverage Report\n\n"
        COMMENT+="| File | Lines | Covered | Missed | Coverage |\n"
        COMMENT+="|------|-------|---------|--------|----------|\n"

        TOTAL_LINES=0
        TOTAL_COVERED=0

        CURRENT_FILE=""
        FILE_LINES=0
        FILE_COVERED=0

        while IFS= read -r line; do
          if [[ "$line" == SF:* ]]; then
            CURRENT_FILE="${line#SF:}"
            # Strip long workspace paths down to just the file name
            CURRENT_FILE=$(basename "$CURRENT_FILE")
            FILE_LINES=0
            FILE_COVERED=0
          elif [[ "$line" == DA:* ]]; then
            # DA:<line_number>,<execution_count>
            COUNT="${line##*,}"
            FILE_LINES=$((FILE_LINES + 1))
            TOTAL_LINES=$((TOTAL_LINES + 1))
            if [[ "$COUNT" -gt 0 ]]; then
              FILE_COVERED=$((FILE_COVERED + 1))
              TOTAL_COVERED=$((TOTAL_COVERED + 1))
            fi
          elif [[ "$line" == "end_of_record" ]]; then
            if [[ $FILE_LINES -gt 0 ]]; then
              FILE_PCT=$((FILE_COVERED * 100 / FILE_LINES))
              FILE_MISSED=$((FILE_LINES - FILE_COVERED))
              COMMENT+="| \`$CURRENT_FILE\` | $FILE_LINES | $FILE_COVERED | $FILE_MISSED | $FILE_PCT% |\n"
            fi
          fi
        done < coverage/lcov.info

        # Summary row
        if [[ $TOTAL_LINES -gt 0 ]]; then
          TOTAL_PCT=$((TOTAL_COVERED * 100 / TOTAL_LINES))
        else
          TOTAL_PCT=0
        fi
        TOTAL_MISSED=$((TOTAL_LINES - TOTAL_COVERED))
        COMMENT+="\n| **Total** | **$TOTAL_LINES** | **$TOTAL_COVERED** | **$TOTAL_MISSED** | **$TOTAL_PCT%** |\n"

        # Choose a badge based on total coverage
        if [[ $TOTAL_PCT -ge 80 ]]; then
          BADGE="ðŸŸ¢"
        elif [[ $TOTAL_PCT -ge 50 ]]; then
          BADGE="ðŸŸ¡"
        else
          BADGE="ðŸ”´"
        fi
        COMMENT+="\n> $BADGE Overall coverage: **$TOTAL_PCT%**\n"
        COMMENT+="\n*Generated by Soroban CI â€” Tests & Coverage*\n"

        # Check if a previous coverage comment exists on this PR
        EXISTING=$(curl -s -X GET \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
          | grep -o '"id":[0-9]*' | head -1 | grep -o '[0-9]*')

        # Find the ID of a comment that was posted by our bot previously
        COMMENT_ID=$(curl -s -X GET \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
          | python3 -c "
        import sys, json
        comments = json.load(sys.stdin)
        for c in comments:
            if 'ðŸ“Š Test Coverage Report' in c.get('body',''):
                print(c['id'])
                break
        ")

        # Update existing comment or create a new one
        if [[ -n "$COMMENT_ID" ]]; then
          curl -s -X PATCH \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$REPO/issues/comments/$COMMENT_ID" \
            -d "$(python3 -c "import json; print(json.dumps({'body': '''$(echo -e "$COMMENT")'''}))")"
        else
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments" \
            -d "$(python3 -c "import json; print(json.dumps({'body': '''$(echo -e "$COMMENT")'''}))")"
        fi

    - name: Upload LCOV report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: lcov-report
        path: coverage/lcov.info

    - name: Upload HTML report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: html-report
        path: coverage/html/